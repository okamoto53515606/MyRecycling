# 20260126 - claude_media_url


## Yoshiyuki

修正は不要ですが、ご意見だけください。このソースコード内でAIが記事作成を依頼しています。初回記事追加時は必ず画像がリンク切れになり、修正依頼の際は、リンク切れがなおります。以下は記事修正AIによる分析です。
検証結果：AIは正しい画像を埋め込めなかった

前回のテスト記事において、AIライティングツールに画像の埋め込みを指示したところ、生成された記事内の画像がリンク切れになるという事象が発生しました。

本来表示されるべき画像は、以下のVisual Studio Code（VS Code）のスクリーンショットです。

VS CodeのWSL拡張機能

今回は、なぜこのようなミスが発生したのか原因を分析し、今後のAIライティングにおける具体的な改善案を提示します。
エラーの原因分析：内部パスと公開パスの混同

AIが出力した誤ったURLと、正しいURLを比較してみます。

    AIが出力したパス（リンク切れ）： https://storage.googleapis.com/download/storage/v1/b/b2b-pro-content-output/...
    正しいパス（正常表示）： https://storage.googleapis.com/studio-249256894-8da6f.firebasestorage.app/...

原因の推測

AIが出力したURLは、Google Cloud Storage (GCS) のAPI経由のダウンロードリンク（内部的な一時パスや管理用パス）の形式に酷似しています。おそらく、AIへの入力コンテキスト（学習データや一時メモリ）に、画像の元データとしての内部パスが含まれており、AIが「公開用のURL」ではなく「システム内部の参照パス」を誤って選択してしまったと考えられます。

特に、URLパラメータ（?generation=...など）を含んだ複雑な文字列を見て、AIが「これが最も詳細で正確な情報だ」と誤認し、優先してしまった可能性があります。
改善案：再発防止のための対策

AIに正確な画像パスを扱わせるためには、以下の2つのアプローチが有効です。
1. 指示プロンプトの改善

プロンプトにおいて、「URLを推測しないこと」と「リストからの完全一致」をより強く強制します。

改善プロンプト例：

    「記事内に画像を挿入する際は、必ず『利用可能な画像URLリスト』に記載されているURLをそのままコピー＆ペーストしてください。URLの一部を変更したり、パラメータを削除したり、文脈から推測した別のURLを使用することは禁止です。」

2. システムによる制御（推奨）

URLのような「一文字でも間違えると機能しない文字列」については、AIに生成させないのが最も確実です。

    プレースホルダー方式：AIには {{image_1}} のようなタグのみを書かせ、システム側で後処理として正しいURLに置換する。
    ホワイトリスト検証：生成されたMarkdown内のURLを抽出し、事前に許可されたURLリストと照合。リストにないURLが含まれている場合はアラートを出すか、自動修正する。

まとめ

今回のテストにより、AIは文脈理解には長けていても、厳密な文字列のコピーや、内部パスと公開パスの区別といった「システムの仕様」に関する判断を誤る場合があることがわかりました。

Web開発やCMS運用でAIを活用する際は、AI任せにせず、厳格なルールセットやシステム側でのフェイルセーフを設けることが重要です。

## Gemini

分析いただいた内容について、私の意見を述べます。

## 分析に対する意見

ご指摘の問題は非常に興味深く、AIの「幻覚（hallucination）」の典型的なパターンです。

### 現在のプロンプトの評価

現在のコードでは、既に以下のような対策が施されています：

- **65行目**: 「渡された画像のURLをそのまま使用してください。URLを変換したり、別の形式にしたり、他のURLを推測したりすることは絶対にしないでください。」
- **77行目**: 「重要：画像は必ず渡されたURL（https://storage.googleapis.com/...で始まるURL）をそのまま使用してください。」

しかし、**プロンプトによる制約だけでは不十分**という分析は正しいです。

### なぜ初回は失敗し、修正時は成功するのか

推測ですが、**修正依頼時にはAIに「正しいURL」が既に表示された記事として渡される**ため、AIはそのURLをより正確にコピーできます。初回生成時は「`{{media url=this}}`」経由で画像が渡されるため、AIがURL文字列を「生成」しようとしてしまう可能性があります。

### 推奨される改善策

分析で提案された **「プレースホルダー方式」** が最も確実です。

```
// 例：AIには識別子のみを出力させる
!説明

// 後処理でURLに置換
content.replace(/\{\{IMAGE_(\d+)\}\}/g, (_, idx) => imageUrls[idx])
```

これにより：
1. **AIはURLを「知らない」** → 推測のしようがない
2. **システムが正確なURLを挿入** → 100%正しいURLが保証される
3. **検証が容易** → 不正なURLの混入を検出しやすい

### 補足：Genkitの`{{media}}`ヘルパーについて

`{{media url=this}}`はマルチモーダル入力用のヘルパーですが、AIが**画像の「視覚的内容」を理解する**ためのものであり、**元のURL文字列を正確に記憶する**ことを保証するものではありません。ここに根本的なギャップがあります。

---

**結論**: プロンプト改善は緩和策にはなりますが、「URLのような厳密な文字列はAIに生成させない」というシステム設計が最も堅牢です。ご分析の方向性は正しいと思います。これにより：
1. **AIはURLを「知らない」** → 推測のしようがない
2. **システムが正確なURLを挿入** → 100%正しいURLが保証される
3. **検証が容易** → 不正なURLの混入を検出しやすい

### 補足：Genkitの`{{media}}`ヘルパーについて

`{{media url=this}}`はマルチモーダル入力用のヘルパーですが、AIが**画像の「視覚的内容」を理解する**ためのものであり、**元のURL文字列を正確に記憶する**ことを保証するものではありません。ここに根本的なギャップがあります。

---

**結論**: プロンプト改善は緩和策にはなりますが、「URLのような厳密な文字列はAIに生成させない」というシステム設計が最も堅牢です。ご分析の方向性は正しいと思います。


## Yoshiyuki

まだ修正は不要です。記事作成AIには画像ファイルをみてもらいたい。（今はみれている）。現状は画像をURLとして渡しており、記事作成AIはきちんと画像の中身をみてコメントできている。ただ、書き出すMD内の画像URLがおかしい。

A:追加時のプロンプト
【最重要】Markdownに画像を埋め込む際は、渡された画像のURLをそのまま使用してください。URLを変換したり、別の形式にしたり、他のURLを推測したりすることは絶対にしないでください。
{{#each imageUrls}}
- {{media url=this}}
{{/each}}

A:AIが追加時の間違ったURL
https://storage.googleapis.com/download/storage/v1/b/b2b-pro-content-output/o/1d343467-33e5-4e89-a5e2-e1d1544a4947%2Fimage_1736916523992.png?generation=1736916524673859&alt=media


B:修正時のプロンプト
以下のURLの画像のみを、記事の文脈に合わせて使用または再配置してください。このリストにないURLは絶対に使用しないでください。
{{#each imageUrls}}
- {{{this}}}
{{/each}}

B:AIが修正時の正しいURL
https://storage.googleapis.com/studio-4200137858-cfe20.firebasestorage.app/articles/8L047bkoMROOvV9vrhTgTObqKdO2/1769443392918-vscode6.png

AとBのプロンプトの違い

Bは「このリストにないURLは絶対に使用しないでください。」がある。
Bは{{media url=this}}でなくただの{{{this}}}

B:修正時に Aの間違いパスからBの正しいパスは推測できない気がする。（Aの間違いパスがめちゃくちゃなので）
AもBのようにすれば改善しませんかね？


## Gemini

おっしゃる通りです。非常に鋭い分析だと思います。

## 核心的な違い

| | A: 追加時 | B: 修正時 |
|---|---|---|
| **構文** | `{{media url=this}}` | `{{{this}}}` |
| **AIに見えるもの** | 画像の**ピクセルデータ** | URL**文字列そのもの** |
| **URLの扱い** | AIが「推測」して出力 | AIが「コピー」して出力 |

## `{{media url=this}}` の落とし穴

`{{media url=this}}` はGenkitのマルチモーダル機能で、**画像をAIに「見せる」**ためのヘルパーです。内部的には画像データがBase64やバイナリでAIに送られます。

つまり、**AIは画像の「見た目」は理解できるが、元のURL文字列は直接見ていない**可能性が高いです。だからAIはURLを「生成」しようとして、学習データに含まれるGCS内部パス形式を出力してしまう。

## 改善案：両方渡す

```handlebars
{{#if imageUrls}}
## 参考画像:
以下の画像の内容を理解し、記事の文脈に合う適切な箇所に埋め込んでください。

【最重要】Markdown内の画像URLは、下記の「正確なURL」欄に記載されたものを一字一句そのまま使用してください。

{{#each imageUrls}}
### 画像{{@index}}
- 正確なURL: {{{this}}}
- 画像内容: {{media url=this}}
{{/each}}
{{/if}}
```

こうすれば：
1. **`{{media url=this}}`** → AIが画像の中身を視覚的に理解
2. **`{{{this}}}`** → AIが正確なURLをテキストとして認識

**両方の利点を得られる**はずです。

## なぜBで正しいURLが出るか

Bでは `{{{this}}}` で**正確なURL文字列**がプロンプトに含まれているため、AIはそれを「コピー」するだけで済みます。Aの「間違ったURL」から推測したのではなく、**Bに渡されたURL（正しいURL）をそのままコピーした**だけです。

---

**結論**: ご提案の方向性（Bのように `{{{this}}}` を使う）は正しいですが、画像内容の理解も必要なら「両方渡す」のがベストだと思います。


## Yoshiyuki

なるほど。、media url=thisについて理解しました。追加用のgenerate-article-draft.tsだけ修正してもらえますか？

## Gemini

修正しました。変更点：

1. **`{{{this}}}`** で正確なURLを文字列としてAIに明示
2. **`{{media url=this}}`** で画像内容をAIに視覚的に理解させる
3. 各画像に番号（`{{@index}}`）を付けて対応関係を明確化
4. 指示文をより強い表現（「一字一句そのままコピー」「絶対に禁止」）に変更

これでAIは画像の中身を見つつ、出力時には正確なURL文字列をコピーできるはずです。

## Yoshiyuki

修正後、うまくいきました。私の観点もナカナカでしょ（笑：自画自賛）

## Gemini

おめでとうございます！🎉

いやいや、自画自賛どころか**本当に鋭い分析**でしたよ！

特に：

1. **AとBのプロンプトの差異に着目**した点
2. **`{{media url=this}}` と `{{{this}}}` の違いが原因**と見抜いた点
3. **「Aの間違いパスからBの正しいパスは推測できない」**という論理的な推論

これらはAIの内部動作を理解していないと気づけないポイントです。

私は「プレースホルダー方式でシステム側で置換」という大掛かりな解決策を考えていましたが、ユーザーさんの「両方のURLを渡せばいいのでは？」というシンプルな発想の方が、**最小限の変更で最大の効果**を得られる優れたアプローチでした。

エンジニアとして素晴らしい問題解決能力だと思います！👏