# 個人向けメディアシステム「homepage」セットアップ手順書Part2

## 〜 Stripe連携（サンドボックス環境）編 〜

> **はじめに**
> 
> この手順書では、有料記事の販売機能を追加するための「Stripe連携」の設定方法を解説します。
> 
> 「Stripe」を使うことで、クレジットカード決済機能を簡単にサイトに追加できます。今回は**サンドボックス（テスト環境）**での設定なので、実際のお金は動きません。安心して練習できます！
> 
> [個人向けメディアシステム「homepage」セットアップ手順書Part1](setup1.md) と同様に、一つひとつはシンプルな作業です。**焦らず、ゆっくり進めてください。**

---

## 📋 目次

1. [Stripeにアカウントを作成する](#手順1-stripeにアカウントを作成する)
2. [サンドボックスのワークベンチを開く](#手順2-サンドボックスのワークベンチを開く)
3. [APIキーをメモする](#手順3-apiキーをメモする)
4. [Webhookを作成する](#手順4-webhookを作成する)
5. [税率を作成する](#手順5-税率を作成する)
6. [3Dセキュアの設定](#手順6-3dセキュアの設定)
7. [領収書メール設定](#手順7-領収書メール設定)
8. [.envファイルを編集する](#手順8-envファイルを編集する)
9. [本番サイトに反映する](#手順9-本番サイトに反映する)
10. [動作確認](#手順10-動作確認)

---

## 📝 前提条件

この手順書を始める前に、以下が完了していることを確認してください：

- ✅ **[個人向けメディアシステム「homepage」セットアップ手順書Part1](setup1.md) のすべての手順が完了していること**
- ✅ サイトが独自ドメインで公開されていること
- ✅ 管理者アカウントが作成されていること

---

## 🎯 この手順書のゴール

この手順書を完了すると、以下ができるようになります：

- 💳 **有料記事の販売** - クレジットカードで課金できる記事を作成
- 🧪 **サンドボックス環境でのテスト** - 実際のお金を使わずに決済機能をテスト
- 🧾 **領収書の自動発行** - 購入者に領収書を表示

> **📌 本番環境について**
> 
> この手順書では**サンドボックス（テスト環境）**での設定を行います。
> 実際にお客様から課金を受けるための**本番環境の設定**（Stripeの審査が必要）については、後日別の手順書を用意する予定です。

---

## 💡 Stripeとは？

**Stripe（ストライプ）**は、世界中で使われているオンライン決済サービスです。

### Stripeを使うメリット

| メリット | 説明 |
|---------|------|
| 🔒 **安全性が高い** | クレジットカード情報はStripeが管理。あなたのサイトでは扱いません |
| 🌍 **世界標準** | 世界中の企業が採用している信頼性の高いサービス |
| 💰 **初期費用ゼロ** | 月額費用なし。決済が発生した時だけ手数料がかかります |
| 🧪 **テスト環境完備** | サンドボックスで実際のお金を使わずに動作確認できます |

### サンドボックスとは？

**サンドボックス**は「砂場」という意味で、**テスト用の安全な環境**のことです。

- 💵 実際のお金は一切動きません
- 🔄 何度でも自由にテストできます
- ❌ 失敗しても問題ありません

> **💡 初心者の方へ**
> 
> 「決済機能」と聞くと難しそうに感じるかもしれませんが、Stripeがほとんどの複雑な処理を代行してくれます。この手順書通りに進めれば、安心して設定できますよ！

---

## 📝 メモする項目一覧

セットアップ中に、いくつかの設定値をメモしておく必要があります。  
お手元にテキストエディタ（メモ帳など）を開いておくと便利です。

| 項目名 | メモするタイミング |
|--------|-------------------|
| 公開可能キー | 手順3 |
| シークレットキー | 手順3 |
| 署名シークレット | 手順4 |
| 税率ID | 手順5 |

---

> **💡 この手順書で使用するドメイン名について**
> 
> 以降の説明では、あなたのサイトのドメインが `test.okamomedia.tokyo` だと仮定して説明を進めます。  
> 実際の作業では、**ご自身で取得したドメイン名に置き換えて**ください。

---

## 手順1: Stripeにアカウントを作成する

Stripeのアカウントを作成します。

### 手順

1. 以下のURLにアクセスします

👉 https://dashboard.stripe.com/register

2. 必要事項を入力してアカウントを作成します
   - メールアドレス
   - 氏名
   - 国
   - パスワード

> **📌 ポイント**
> - すでにStripeアカウントをお持ちの場合は、ログインしてください
> - パスワードは安全なものを設定し、忘れないようにメモしておきましょう

---

## 手順2: サンドボックスのワークベンチを開く

テスト環境（サンドボックス）の管理画面を開きます。

### 手順

1. Stripeにログイン後、画面上部の「**サンドボックス**」または「**Sandbox**」をクリック

![サンドボックス](screenshot/Stripe2.png)

> **💡 ワークベンチとは？**
> 
> Stripeの操作や設定を行うための管理画面のことです。ここでAPIキーの確認やWebhookの設定を行います。

---

## 手順3: APIキーをメモする

サイトとStripeを連携するために必要な「APIキー」を取得します。

### 手順

1. ワークベンチの画面で、以下の2つのキーを確認します
   - **公開可能キー**（pk_test_で始まる）
   - **シークレットキー**（sk_test_で始まる）

2. それぞれの「コピー」ボタンをクリックして、**メモ帳に保存**しておきます

![APIキー](screenshot/Stripe3.png)

> **⚠️ 重要**
> 
> **シークレットキー**は非常に重要な情報です。
> - 絶対に他人に教えないでください
> - ブログやSNSに公開しないでください
> - Git等のバージョン管理システムにコミットしないでください

> **💡 APIキーの役割**
> 
> | キー名 | 役割 | 公開 |
> |--------|------|------|
> | 公開可能キー | ブラウザで決済フォームを表示するため | OK |
> | シークレットキー | サーバーで決済処理を行うため | NG |

---

## 手順4: Webhookを作成する

**Webhook（ウェブフック）**は、Stripeからあなたのサイトに「決済が完了しましたよ」などの通知を送る仕組みです。

> **💡 Webhookとは？**
> 
> 例えるなら「電話の着信通知」のようなものです。
> お客様が支払いを完了すると、Stripeがあなたのサイトに「支払いが完了しました」と自動的に連絡してくれます。

### 手順

1. ワークベンチで「**Webhook**」タブを選択し、「**送信先を追加する**」ボタンをクリック

![Webhook作成](screenshot/Webhook1.png)

2. 以下を設定します
   - **APIバージョン**：`2025-12-15.clover` を選択
   - 「**すべてのイベント**」タブで `checkout.session.completed` を検索
   - `checkout.session.completed` にチェックを入れる
   - 「**続行**」ボタンをクリック

![Webhookイベント選択](screenshot/Webhook2.png)

> **💡 checkout.session.completedとは？**
> 
> 「お客様がチェックアウト（支払い）を完了した」というイベントです。
> このイベントを受け取ることで、サイトは「支払いが完了したので、記事を閲覧可能にする」という処理ができます。

3. 「**Webhookエンドポイント**」を選択し、「**続行**」ボタンをクリック

![エンドポイント選択](screenshot/Webhook3.png)

4. 「**エンドポイントURL**」に以下を入力し、「**送信先を作成する**」ボタンをクリック

```
https://test.okamomedia.tokyo/api/stripe/webhook
```

> **⚠️ 注意**  
> `test.okamomedia.tokyo` の部分は、**ご自身のドメイン名に書き換えて**ください。

![エンドポイントURL入力](screenshot/Webhook4.png)

5. 作成完了後、「**署名シークレット**」の横にある**目玉ボタン**をクリック

![署名シークレット表示](screenshot/Webhook5.png)

6. 「**コピー**」ボタンが表示されるので、署名シークレットを**メモ帳に保存**しておきます

![署名シークレットコピー](screenshot/Webhook6.png)

> **💡 署名シークレットとは？**
> 
> Webhookの通知が「本物のStripeからの通知」であることを確認するための暗号キーです。
> これにより、悪意のある第三者が偽の通知を送ってきても、サイトが騙されることを防げます。

---

## 手順5: 税率を作成する

日本の消費税（10%）の設定を行います。

### 手順

1. 左メニューの「**商品カタログ**」から「**税率**」をクリック
2. 右上の「**税率を作成**」ボタンをクリック

![税率作成](screenshot/Stripe4.png)

3. 以下の通り入力し、「**税率を追加**」ボタンをクリック
   - **表示名**：消費税
   - **税率**：10（%）
   - **税率のタイプ**：内税

![税率設定](screenshot/Stripe5.png)

> **💡 内税とは？**
> 
> 商品価格に税金が含まれている方式です。
> 例：1,100円の商品 → 本体価格1,000円 + 消費税100円

4. 作成された税率の「**コピー**」ボタンをクリックし、**税率ID**（`txr_`で始まる）を**メモ帳に保存**

![税率IDコピー](screenshot/Stripe6.png)

---

## 手順6: 3Dセキュアの設定

**3Dセキュア**は、クレジットカードの不正利用を防ぐための追加認証機能です。

> **💡 3Dセキュアとは？**
> 
> オンラインでカード決済をする際に、カード会社が本人確認を行う仕組みです。
> 例えば、SMSで送られてくる確認コードを入力するなどの追加認証が求められます。
> これにより、カードの不正利用を防ぐことができます。

### 手順

1. 右上の**歯車アイコン**（設定）をクリック

2. 「**Billing**」→「**サブスクリプションとメール通知**」を開く

3. 「**Radar のルールに一致する Billing 支払いに 3D セキュアをリクエスト**」のチェックを**ON**にする

![3Dセキュア設定](screenshot/Stripe7.png)

> **📌 ポイント**
> 
> 3Dセキュアを有効にすることで、万が一の不正利用時にチャージバック（返金請求）のリスクを軽減できます。

---

## 手順7: 領収書メール設定

購入完了時に、お客様に領収書を表示する設定を行います。

### 手順

#### 7-1. 決済成功時のメール設定

1. 右上の**歯車アイコン**（設定）をクリック

2. 「**ビジネス**」→「**送信メール**」を開く

3. 以下を設定します
   - 「**決済成功時**」のチェックを**ON**
   - 「**領収書メールに登録番号を記載する**」を**ON**（登録番号がない方は省略可）

![メール設定](screenshot/Stripe8.png)

> **💡 登録番号とは？**
> 
> インボイス制度の「適格請求書発行事業者」として登録された場合に付与される「T」から始まる13桁の番号です。
> 個人の方や未登録の方は、この設定は省略して構いません。

#### 7-2. 請求書の税表示設定

1. 右上の**歯車アイコン**（設定）をクリック

2. 「**Billing**」→「**請求書**」を開く

3. 以下を設定して「**保存**」ボタンをクリック
   - 「**デフォルトの項目価格**」は「**税込み**」を選択
   - 「**納税者番号**」の欄で登録番号（Tから始まる番号）を登録（登録番号がない方は省略可）

![請求書設定](screenshot/Stripe9.png)

> **🎉 Stripeの設定完了！**  
> お疲れさまでした！Stripe側の設定はこれで完了です。
> 次は、Firebase Studioでサイトの設定を行います。

---

## 手順8: .envファイルを編集する

メモした情報を、サイトの設定ファイルに登録します。

### 手順

1. 別タブで**Firebase Studio**を開く

👉 https://studio.firebase.google.com/

2. 右上の「**</>**」をクリック

![コード画面へ](screenshot/Terminal1.png)

3. GEMINI の下の「**＋**」ボタンをクリック → 「**New Chat**」を選択

![New Chat](screenshot/Terminal2.png)

> **📌 ポイント**  
> 「New Chat」で普通のGeminiに切り替えることをおすすめします。

4. 左側のエクスプローラーで「**.env**」ファイルをクリック

![envファイル](screenshot/env1.png)

5. `.env`ファイルの中に、以下の4つの項目を見つけて、メモした値をペーストします

```
# stripe API 公開可能キー（クライアントサイドで使用）
NEXT_PUBLIC_STRIPE_PUBLIC_KEY="ここに公開可能キーをペースト"

# stripe API シークレットキー（サーバーサイドのみ）
STRIPE_SECRET_KEY="ここにシークレットキーをペースト"

# stripe 署名シークレット
STRIPE_WEBHOOK_SECRET="ここに署名シークレットをペースト"

# stripe > 商品カタログ > 税率 > 税率 ID を作成 (txr_からはじまるID)
STRIPE_TAX_RATES="ここに税率IDをペースト"
```

| 環境変数名 | ペーストする値 |
|-----------|--------------|
| `NEXT_PUBLIC_STRIPE_PUBLIC_KEY` | 公開可能キー（pk_test_...） |
| `STRIPE_SECRET_KEY` | シークレットキー（sk_test_...） |
| `STRIPE_WEBHOOK_SECRET` | 署名シークレット（whsec_...） |
| `STRIPE_TAX_RATES` | 税率ID（txr_...） |

![env編集](screenshot/env3.png)

> **📌 ポイント**  
> すべての値は**ダブルクォーテーション（""）の中に**ペーストしてください。

> **⚠️ よくある間違い**
> - 値の前後に余計なスペースが入っている
> - ダブルクォーテーションが欠けている
> - 別のキーの値を間違えてペーストしている
> 
> うまく動かない場合は、もう一度確認してみてください。

---

## 手順9: 本番サイトに反映する

ここまでの設定を本番サイトに反映（デプロイ）します。

### 手順

1. 右上の「**Publish**」ボタンをクリック

![Publishボタン](screenshot/FirebaseStudio4.png)

2. 「**Publish**」ボタンをクリック

![Publish確認](screenshot/FirebaseStudio8.png)

> **⏰ デプロイには数分かかります**  
> 完了するまでお待ちください。画面が動いていれば、処理は進んでいます。

---

## 手順10: 動作確認

いよいよ最後の手順です！実際に決済機能が動作するかテストしましょう。

### 事前準備

> **⚠️ 重要：テスト用のGoogleアカウントを用意してください**
> 
> 管理者アカウントでログインしている場合、**課金なしで有料記事が閲覧できてしまいます**。
> そのため、**管理者とは別のGoogleアカウント**を用意してテストしてください。
> 
> Googleアカウントをお持ちでない場合は、テスト用に新しく作成してください。

### 手順

1. 管理画面から**有料記事を1つ作成**しておきます
   - 左メニューの「記事管理」→「新規作成」
   - 記事を作成し、「**有料**」設定をONにして公開

2. ブラウザの**シークレットウィンドウ**（またはプライベートウィンドウ）を開く

> **💡 シークレットウィンドウの開き方**
> - **Chrome**: `Ctrl + Shift + N`（Mac: `Cmd + Shift + N`）
> - **Firefox**: `Ctrl + Shift + P`（Mac: `Cmd + Shift + P`）
> - **Edge**: `Ctrl + Shift + N`

3. あなたのサイトにアクセスし、**管理者とは別のGoogleアカウント**でログイン

4. 作成した**有料記事**をクリック

![有料記事](screenshot/pay1.png)

5. 「**購入する**」ボタンをクリック

![購入する](screenshot/pay2.png)

6. **テストカード情報**を入力し、「**支払う**」ボタンをクリック

![支払い画面](screenshot/pay3.png)

#### テストカード情報

| 項目 | 入力する値 |
|------|-----------|
| 電話番号 | 自分の電話番号 |
| カード番号 | `4242 4242 4242 4242` |
| 有効期限 | 未来の任意の日付（例: `12/30`） |
| CVC | 任意の3桁（例: `123`） |
| 郵便番号 | 任意（例: `1000001`） |
| カード名義 (ローマ字) | 任意（例: `TARO TEST`） |

> **📌 ポイント**
> 
> `4242 4242 4242 4242` はStripeが用意した**テスト専用のカード番号**です。
> 実際のお金は一切引き落とされません。安心してテストしてください。

7. 支払い完了画面で「**領収書を表示・ダウンロード**」をクリック

![支払い完了](screenshot/pay4.png)

8. **領収書が表示されれば成功です！** 🎉

![領収書](screenshot/receipt.png)

> **📌 サンドボックス環境での注意点**
> 
> サンドボックス環境では、**領収書メールは送信されません**。
> 本番環境に切り替えると、実際にメールが送信されるようになります。

---

### 📋 その他のテストカード（参考）

様々なケースをテストしたい場合は、以下のカード番号を使用できます：

| 用途 | カード番号 |
|------|-----------|
| ✅ 通常の成功 | `4242 4242 4242 4242` |
| 🔐 3Dセキュア認証が必要 | `4000 0027 6000 3184` |
| ❌ カード拒否（残高不足） | `4000 0000 0000 9995` |
| ❌ カード拒否（不正検知） | `4100 0000 0000 0019` |
| ❌ 有効期限切れ | `4000 0000 0000 0069` |
| ❌ CVC不一致 | `4000 0000 0000 0127` |

> **💡 テストのコツ**
> 
> エラーケースもテストしておくと、実際の運用時にお客様から問い合わせがあった場合に対応しやすくなります。

---

### 🔄 再度テストする場合

課金のテストを再度行いたい場合は、**退会処理**を行ってからテストしてください。

1. テスト用アカウントでログイン
2. 画面右下の「**退会**」ボタンをクリック
3. 退会処理を完了
4. 再度ログインして、手順10を最初から実施

![退会ボタン](screenshot/withdraw.png)

---

## 🎉 セットアップ完了！おめでとうございます！

お疲れさまでした！これで**Stripeサンドボックス環境との連携**が完了しました。

### これでできるようになったこと

- ✍️ **有料記事の作成** - 管理画面から有料記事を作成できます
- 💳 **テスト決済** - サンドボックス環境で決済機能をテストできます
- 🧾 **領収書表示** - 購入者に領収書を表示できます

---

## ❓ トラブルシューティング

### よくある問題と対処法

| 症状 | 原因 | 対処法 |
|-----|------|-------|
| 決済画面が表示されない | 公開可能キーの設定ミス | `.env`ファイルの`NEXT_PUBLIC_STRIPE_PUBLIC_KEY`を確認 |
| 決済後に記事が読めない | Webhook設定のミス | エンドポイントURLが正しいか、署名シークレットが正しいか確認 |
| 「無効なAPIキー」エラー | シークレットキーの設定ミス | `.env`ファイルの`STRIPE_SECRET_KEY`を確認 |
| 税金が表示されない | 税率IDの設定ミス | `.env`ファイルの`STRIPE_TAX_RATES`を確認 |
| 設定変更が反映されない | デプロイされていない | 手順9のPublish操作をもう一度実行 |

### チェックリスト

問題が発生した場合は、以下を順番に確認してください：

- [ ] `.env`ファイルの4つの値はすべて正しくペーストされているか
- [ ] ダブルクォーテーションの中に値が入っているか
- [ ] 値の前後に余計なスペースが入っていないか
- [ ] WebhookのエンドポイントURLは自分のドメインになっているか
- [ ] Publishボタンでデプロイを実行したか

---

## 📝 次のステップ

サンドボックス環境でのテストが完了したら、次は**本番環境の設定**に進みましょう。

👉 **[個人向けメディアシステム「homepage」セットアップ手順書Part3](setup3.md)**

Part3では、以下の内容を解説しています：

- 事業用電話番号・住所の取得（個人情報を公開したくない方向け）
- 特定商取引法に基づく表記の作成
- Stripeの本番化申請と審査
- 本番環境でのStripe設定
- 実際の課金テスト

本番環境が有効になると、実際のお客様からの決済を受け付けられるようになります！

---

**ここまでよく頑張りました！👏**  
有料記事で収益化への第一歩です。素敵なコンテンツを発信してくださいね！
