プログラム修正はまだしないで下さい。
理解した内容や不明点をコメントお願いします。

まず、以下3つのドキュメントと現状のソースコードを確認して下さい。
docs/blueprint.md
docs/database-schema.md
cli/init-settings.ts

以下は、昨日までのGeminiとのやりとりです。
※ステップ1「商品詳細ページ」までは実装完了しています。

Gemini
ご依頼いただいた5つのステップに沿って、以下の通り実装を進めます。既存のコンポーネントやロジック（Stripe連携、認証など）を最大限に再利用し、統一感のある実装を目指します。

ファイル構成:

src/app/products/[id]/page.tsx: 商品データを取得するサーバーコンポーネント。
src/app/products/[id]/product-detail-client.tsx: 状態管理（画像スライダー、モーダル表示）やインタラクションを担うクライアントコンポーネント。page.tsxからこのコンポーネントを呼び出します。
src/components/image-slider.tsx: 画像スライダー用の共通コンポーネントを新規作成します。
実装内容:

データ取得: data.tsにgetProduct(id)とisSoldOut(productId)関数を実装し、サーバーコンポーネント(page.tsx)で商品データと売り切れ状態を取得します。
UI表示:
取得したデータをproduct-detail-client.tsxに渡して表示します。
画像が複数ある場合は、image-slider.tsxコンポーネントでスライダー表示します。
isSoldOutがtrueの場合は「Sold out」と表示します。
注文ボタンの制御:
product-detail-client.tsx内で認証状態をチェックします。
売り切れでなく、ログイン済みの場合のみ、「注文確認画面へ」ボタンを表示します。
売り切れでなく、未ログインの場合は、「ログインして注文する」ボタンを表示し、クリックで既存のログインモーダルを開きます。
ファイル構成:

src/app/orders/[productId]/confirm/page.tsx: 注文確認ページのメインファイル。
実装内容:

アクセス制御: ページの冒頭で、ログイン済みかつ対象商品が売り切れでないことをサーバーサイドで厳格にチェックします。条件を満たさない場合は、商品詳細ページやトップページにリダイレクトさせます。
データ取得: getProduct(productId)と、getMeetingLocations()（後述）をdata.tsに作成して使用します。
UI表示:
商品情報（商品名、価格）を表示します。
meeting_locationsコレクションから取得した場所をプルダウンで選択できるようにします。
受け渡し日時をプルダウンで選択できるようにします。
共通コンポーネント/関数の作成:
受け渡し場所詳細モーダル: src/components/modals/meeting-locations-modal.tsxを新規作成します。内容はmeeting_locationsコレクションの全データを表示します。
注文に関する注意書き: src/components/shared/order-notices.tsxを新規作成し、注意書き（赤字）を共通コンポーネントPendingConfirmationNoticeとして実装します。
規約同意文言: paywall-client.tsxを参考に、src/components/shared/legal-agreement.tsxのような共通コンポーネントとして切り出します。
注文処理:
「利用規約等に同意して注文する」ボタンがクリックされたら、選択された商品ID、受け渡し場所、日時をbodyに含めて、Stripeチェックアウトセッション作成用のAPI（後述）へPOSTリクエストを送信します。
APIから返却されたStripeの決済URLへリダイレクトさせます。
ファイル構成:

src/app/api/stripe/create-checkout-session/route.ts のようなAPIルートを新規作成します（既存の構成に合わせます）。
実装内容:

注文確認画面からのリクエストを受け取ります。
サーバー側で再度、認証状態と商品の売り切れ状態をチェックします。
Stripeのチェックアウトセッションを作成します。その際、**即時決済ではなく与信枠の確保（オーソリ）**のみを行うため、payment_intent_dataにcapture_method: 'manual'を設定します。
Webhookで注文情報を復元できるよう、セッションのmetadataにproductId, userId, meetingLocation, meetingDateTime等の情報を格納します。
ファイル構成:

src/app/api/stripe/webhook/route.ts を修正します。
実装内容:

checkout.session.completed イベントをリッスンするcaseを追加します。
イベントオブジェクトからmetadataとpayment_intentIDを取得します。
【重要】レースコンディション対策として、ここでもう一度 isSoldOut(productId) をチェックします。 もしユーザーが決済中に商品が売り切れた場合、注文は作成せず、確保した与信をキャンセルする処理（stripe.paymentIntents.cancel）を追加します。
売り切れでなければ、ordersコレクションに新しい注文ドキュメントを作成します。
status: 'pending_confirmation'（注文確定待ち）
その他、metadataから取得した情報、StripeのPayment Intent IDなどを保存します。
ファイル構成:

src/app/payment/success/page.tsx を修正します。
実装内容:

「ご注文ありがとうございます」といったメッセージを表示します。
領収書へのリンクは表示しません。
（２）で作成した共通コンポーネント PendingConfirmationNotice を使い、「注文はまだ確定しておりません」という旨の注意書き（赤字）を表示します。
実装に着手する前に、いくつか確認させてください。

受け渡し日時の選択肢について: 注文確認画面でユーザーが選択できる「受け渡し日」や「受け渡し時刻」の選択肢は、どのように決定しますか？

例A: 常に「3日後～14日後」を表示する
例B: settingsコレクションに「注文から最短n日後」「受付可能な曜日」のような設定値を持たせる
例C: meeting_locationsごとに受付可能な日時が異なる
決済中の売り切れ（レースコンディション）の対応: Webhook処理の際、もし商品が売り切れになっていた場合、「与信枠をキャンセルし、注文データを作成しない」という方針で問題ないでしょうか？その場合、ユーザーにはどのような通知が行われるのが望ましいですか？（例：運営者が手動で謝罪メールを送る、など）

共通コンポーネント化について: 注意書き（赤字）をgetXxxxという関数ではなく、PendingConfirmationNoticeというReactコンポーネントとしてsrc/components/shared/order-notices.tsxに実装する方針です。Reactの慣例に沿ったこの方法でよろしいでしょうか？

上記の方針と確認事項について、ご意見やご回答をいただけますでしょうか。承認をいただきましたら、実装に着手いたします。




Yoshiyuki
（確認１）受け渡し日時の選択肢について 日付はStripeのオーソリ期限が7日なので、７日後を上限として、有効な日付（available_weekdaysとunavailable_dates）を表示。 時刻はavailable_timesのとおり。

（確認２）Webhook処理の際、もし商品が売り切れになっていた場合、「与信枠をキャンセルし、注文データを作成しない」という方針です。 ユーザー対応ですが、「DBに今回の会員IDと商品IDに一致する注文ステータス＝authorizedの注文履歴がある場合、成功とみなしますが、ない場合、注文エラーとみなします」となります。

（確認３）共通コンポーネント化ですが、メールでも使うかもしれないので、テキストを返すgetXXXXがよいです。（将来的にはこの文言をDBにいれるかもしれません）

商品詳細のボタンは「注文確認画面へ」でなく「注文する」ボタンがいいです。（まず注文するという意思表示から始まるとおもいましたので）。

注文確認画面はプルダウンでなく選択しがみれる形にしたいです。 受け渡し場所は選択肢の横に詳細はこちら（モーダル開く）をつけたい。 日付の選択も基本土日なので、選択肢がみえるようにして、曜日も表示。 日付選択とは別に時刻を選択（ここはプルダウンでOK)

src/app/payment/cancel/の方も今回の内容にあわせて文言を修正してほしいです。 src/app/payment/success/について、領収書リンクのかわりマイページ（これから作る画面。注文内容を確認したり、ここからキャンセルや返品ができる）へのリンクをつけてほしいです。

Gemini
ご確認ありがとうございます。詳細なご指示とフィードバックをいただき、実装の解像度が大きく向上しました。

いただいた内容に基づき、実装方針を以下のように更新しました。

UI/UX:
URL: /products/[商品ID]
商品画像が複数ある場合はスライダーで表示します。
isSoldOutをチェックし、売り切れの場合は「Sold out」と表示します。
ログイン状態で、かつ売り切れでない場合にのみ「注文する」ボタンを表示します。このボタンは次の注文確認画面に遷移します。
未ログインの場合は「ログインして注文する」ボタンを表示し、クリックするとログインモーダルが開きます。
ファイル:
src/app/products/[id]/page.tsx (サーバーコンポーネント)
src/app/products/[id]/product-detail-client.tsx (クライアントコンポーネント)
src/components/image-slider.tsx (新規作成)
src/lib/data.tsにgetProduct(id)を追加。
UI/UX:
URL: /orders/[商品ID]/confirm
アクセス制御: ログイン済み、かつ商品が売り切れでないことをサーバー側でチェックし、満たさない場合はリダイレクトします。
受け渡し場所: 選択肢をラジオボタンのように一覧表示し、各選択肢の横に「詳細はこちら」リンクを設置。クリックで場所の詳細情報をモーダル表示します。
受け渡し日: Stripeのオーソリ期限（7日間）を上限とし、店舗設定（available_weekdays, unavailable_dates）に基づいて選択可能な日付をボタン形式で一覧表示します（曜日も併記）。
受け渡し時刻: 日付が選択されたら、選択可能な時間帯（available_times）をプルダウンで表示します。
各種文言:
注文に関する注意書き（「日時はまだ確定ではありません」等）を表示します。
利用規約やプライバシーポリシーへの同意を求める定型文を表示します。
ファイル/関数:
src/app/orders/[productId]/confirm/page.tsx (メインのページ)
src/components/modals/meeting-locations-modal.tsx (新規作成)
src/lib/text-utils.ts に、注意書きテキストを返すgetOrderNoticeText()のような関数を新規作成します。
src/components/shared/legal-agreement.tsx (規約同意コンポーネント)
処理:
注文確認画面の「同意して注文する」ボタンから呼び出されます。
サーバー側で認証状態と在庫を再度チェックします。
Stripeのチェックアウトセッションを作成します。このとき、即時決済ではなく**与信枠の確保（オーソリ）**のみを行う設定 (capture_method: 'manual') を追加します。
後のWebhook処理で使えるよう、セッションのmetadataにproductId, userId, meetingLocationId, meetingDateTime等を保存します。
ファイル:
src/app/api/stripe/create-checkout-session/route.ts (新規作成)
処理:
決済完了通知 (checkout.session.completed) を受け取ります。
【重要】ここでもう一度、在庫（isSoldOut）をチェックします。
万が一売り切れの場合（レースコンディション）: ordersコレクションには何も登録せず、確保した与信枠をstripe.paymentIntents.cancelで即時キャンセルします。
在庫がある場合: ordersコレクションに注文ドキュメントを新規作成します。ステータスはauthorizedとします。
ファイル:
src/app/api/stripe/webhook/route.ts (修正)
注文完了画面 (/payment/success)
処理: Webhookの処理結果をユーザーに正しく伝えるため、ページ表示時に注文が正常に作成されたかをDBで確認します。
注文成功時: 「ご注文ありがとうございます」というメッセージ、getOrderNoticeText()で取得した注意書き、そして将来作成するマイページへのリンクを表示します。（領収書リンクは非表示）
注文失敗時（決済中の売り切れなど）: 「決済処理中に売り切れとなったため注文を完了できませんでした」という旨のエラーメッセージを表示します。
注文キャンセル画面 (/payment/cancel)
処理: 今回のフローに合わせて、「注文手続きはキャンセルされました。商品はまだ確保されていません。」といったメッセージに修正します。
ファイル:
src/app/payment/success/page.tsx (修正)
src/app/payment/cancel/page.tsx (修正)
上記の方針で実装を進めてまいります。 まずは、**ステップ1「商品詳細ページ」**の実装から着手します。src/lib/data.tsにgetProduct関数を追加し、関連ファイルを作成していきます。

※ステップ1「商品詳細ページ」までは実装完了しています。
