# 個人向けメディアシステム「homepage」運用・カスタマイズガイド

> **このドキュメントについて**
> 
> このガイドでは、homepageの日々の運用で役立つ情報と、上級者向けのカスタマイズ設定をまとめています。
> 
> セットアップが完了した後、運用中に参照してください。
> 
> - 📋 **運用TIPS** - 日常的な管理作業のやり方
> - 🔧 **上級者向けTIPS** - セキュリティ強化や高度なカスタマイズ

---

## 📋 目次

### 運用TIPS
- [取引履歴や購入者の確認](#取引履歴や購入者の確認)
- [未購入だがログイン済の利用者を確認する](#未購入だがログイン済の利用者を確認する)
- [クレーム対応で返金する場合](#クレーム対応で返金する場合)
- [homepageの管理者権限の付与と削除](#homepageの管理者権限の付与と削除)
- [homepageの記事のタグの一括変更](#homepageの記事のタグの一括変更)
- [homepageのプログラムの最新化](#homepageのプログラムの最新化)

### 上級者向けTIPS
- [Firestoreのバックアップを設定したい](#firestoreのバックアップを設定したい)
- [管理画面にIPアドレス制限を実施したい](#管理画面にipアドレス制限を実施したい)
- [CSPを有効にしたい](#cspを有効にしたい)
- [ログインの有効期間を調整したい](#ログインの有効期間を調整したい)
- [ローカルPCでhomepageを動かしたい](#ローカルpcでhomepageを動かしたい)

---

# 📚 運用TIPS

ここからは、日々の運用で役立つ情報をまとめています。

---

## 取引履歴や購入者の確認

homepage管理画面には取引履歴の閲覧機能がないため、**Stripe管理画面**で確認します。

### 手順

1. Stripeダッシュボードにログイン

👉 https://dashboard.stripe.com/

2. 「**支払い**」または「**取引**」メニューから確認

### 参考リンク

👉 https://support.stripe.com/express/questions/where-can-i-view-recent-payouts-and-transactions?locale=ja-JP

---

## 未購入だがログイン済の利用者を確認する

homepage管理画面には利用者情報の閲覧機能がないため、**Firebaseコンソール**のFirestore Databaseで確認します。

### 手順

1. Firebaseコンソールにログイン

👉 https://console.firebase.google.com/

2. 「**構築**」→「**Firestore Database**」をクリック

3. 「**users**」コレクションをクリック

4. ログイン済みユーザーの一覧が表示されます

![usersコレクション](screenshot/collection_uses.png)

---

## クレーム対応で返金する場合

返金はStripe管理画面から行います。

### 手順

1. Stripeダッシュボードにログイン

👉 https://dashboard.stripe.com/

2. 「**支払い**」から対象の取引を選択

3. 「**返金**」ボタンをクリック

4. 返金理由と金額を入力して実行

### 参考リンク

👉 https://docs.stripe.com/refunds?locale=ja-JP

> **📌 返金のポイント**
> 
> - 全額返金と一部返金が選択可能
> - 返金後、お客様には返金通知メールが届きます
> - Stripeの手数料は返金されません（注意）

---

## homepageの管理者権限の付与と削除

Firebase Studioのターミナルからコマンドを実行します。

### 管理者権限の付与

```bash
npm run set-admin -- user@example.com
```

### 管理者権限の削除

```bash
npm run remove-admin -- user@example.com
```

### 管理者権限の確認

```bash
npm run check-admin -- user@example.com
```

> **📌 補足**
> 
> - 「Grant access to Google Cloud resources?」の確認ダイアログが出たら、チェックして「Grant access」をクリック
> - プロジェクトの選択ダイアログが出たら、homepageのプロジェクトを選択

---

## homepageの記事のタグの一括変更

Firebase Studioのターミナルからコマンドを実行します。

### タグの削除

```bash
npm run cli:manage-tags -- --delete="削除したいタグ名"
```

### タグ名の変更（リネーム）

```bash
npm run cli:manage-tags -- --from="古いタグ名" --to="新しいタグ名"
```

> **📌 補足**
> 
> - 「Grant access to Google Cloud resources?」の確認ダイアログが出たら、チェックして「Grant access」をクリック
> - プロジェクトの選択ダイアログが出たら、homepageのプロジェクトを選択

---

## homepageのプログラムの最新化

GitHubから最新のソースコードをダウンロードしてプログラムを更新します。

### 手順

1. Firebase Studioでターミナルを開く

2. 以下のコマンドを順番に実行します

```bash
# -----------------------------------------------------------------------------
# GitHubからソースコードをダウンロード
# -----------------------------------------------------------------------------
echo ""
echo "📥 GitHubからソースコードをダウンロードしています..."
curl -L https://github.com/okamoto53515606/homepage/archive/refs/heads/main.tar.gz | \
  tar -xz --strip-components=1
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# Gitに変更を反映
# -----------------------------------------------------------------------------
echo ""
echo "📝 Gitに変更をコミットしています..."
git add -A
git commit -m "Synchronized with okamoto53515606/homepage"
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# npm パッケージのインストール
# -----------------------------------------------------------------------------
echo ""
echo "📦 npm パッケージをインストールしています..."
echo "   （古いキャッシュを削除中...）"
rm -rf .next node_modules package-lock.json
echo "   （npm install 実行中...これには数分かかる場合があります）"
npm install
echo "   ✅ 完了"
```

### 各コマンドの解説

| コマンド | 説明 |
|---------|------|
| `curl -L ... \| tar -xz --strip-components=1` | GitHubから最新のソースコードをダウンロードして解凍。`--strip-components=1`で不要なフォルダ階層を除去 |
| `git add -A` | すべての変更ファイルをGitの管理対象に追加 |
| `git commit -m "..."` | 変更をGitに記録（コミット） |
| `rm -rf .next node_modules package-lock.json` | 古いビルドキャッシュとパッケージを削除して、クリーンな状態に |
| `npm install` | 必要なパッケージを再インストール |

### Firebase Studioを再起動する

更新を反映するため、Firebase Studioを再起動します。

1. 左上の Firebase Studio ロゴをクリック

2. 「MyHomepage」の横メニューから「**Restart**」をクリック

![Restart](screenshot/Restart.png)

3. 再起動後、「MyHomepage」をクリック

4. 右上の「**</>**」をクリック

> **⏰ 再起動後の注意**
> 
> プログラム入れ替え後、環境が復活するまでに**しばらく時間がかかります**。
> Restartすれば環境の再構成がはじまりますので、気長に待ってください。
> この最新化作業では、`.env`などの個別設定情報は書き換えません。

> **⚠️ 重要：カスタマイズの消失について**
> 
> あなたがシステムをカスタマイズしている場合、**カスタマイズ内容は上書きされて消えてしまいます**。
> 最新化前に、カスタマイズ内容をバックアップしておくことをおすすめします。

---

# 🔧 上級者向けTIPS

ここからは、セキュリティ強化や高度なカスタマイズに関する設定です。

---

## Firestoreのバックアップを設定したい

Firestoreに保存されている記事やユーザー情報を定期的にバックアップする設定です。

### なぜバックアップが必要？

| リスク | 説明 |
|-------|------|
| 誤操作 | 記事を誤って削除してしまった場合 |
| 障害 | システム障害やデータ破損が発生した場合 |
| 不正アクセス | 万が一、データが改ざんされた場合 |

バックアップがあれば、これらの問題が発生しても**過去の状態に復元**できます。

### 設定手順

1. GCPコンソールにログイン

👉 https://console.cloud.google.com/

2. 検索バーに「**firestore**」と入力し、「**Firestore**」をクリック

3. 「**スケジュール バックアップの設定を編集**」をクリック

![Firestoreバックアップ設定1](screenshot/firestore_bakcup1.png)

4. 障害復旧画面が表示されるので、「**編集**」ボタンをクリック

![Firestoreバックアップ設定2](screenshot/firestore_bakcup2.png)

5. バックアップ設定を行います

| 項目 | 推奨設定 | 説明 |
|-----|---------|------|
| バックアップ頻度 | 毎日 | 1日1回自動でバックアップを取得 |
| 保持期間 | 98日間（約3ヶ月） | バックアップを保持する期間 |

6. 「**保存**」ボタンをクリック

> **💡 設定のポイント**
> 
> - **毎日バックアップ**：記事の更新頻度が高い場合におすすめ
> - **保持期間98日間**：問題に気づくまで時間がかかるケースも考慮
> - 保持期間が長いほど、ストレージ費用が増加します（ただし通常は少額）

### 復旧方法（参考）

万が一データの復元が必要になった場合：

1. GCPコンソールのFirestore画面を開く
2. 「**バックアップ**」タブを選択
3. 復元したい日付のバックアップを選択
4. 「**復元**」ボタンをクリック

> **⚠️ 注意**
> 
> - 復元すると、現在のデータが**バックアップ時点のデータで上書き**されます
> - 復元前に、現在のデータのバックアップを取ることをおすすめします
> - 復元には数分〜数十分かかる場合があります

---

## 管理画面にIPアドレス制限を実施したい

管理画面へのアクセスを、特定のIPアドレスからのみに制限できます。

### 自分のIPアドレスを調べる

以下のサイトで確認できます：

👉 https://www.cman.jp/network/support/go_access.cgi

### 設定手順

1. Firebase Studioを開く

👉 https://studio.firebase.google.com/

2. 右上の「**</>**」をクリック

3. 左側のエクスプローラーで「**.env**」ファイルをクリック

4. 以下の行を見つけて編集します

```
# 管理画面の許可IPアドレス 複数ある場合はスペース区切り
ALLOWED_IP_ADDRESSES_FOR_THE_ADMIN_PAGE="xxx.xxx.xxx.xxx"
```

**複数のIPアドレスを許可する場合**：

```
ALLOWED_IP_ADDRESSES_FOR_THE_ADMIN_PAGE="xxx.xxx.xxx.xxx yyy.yyy.yyy.yyy"
```

5. 「**Publish**」ボタンをクリックして反映

> **⚠️ 注意**
> 
> - 自分のIPアドレスを正しく設定しないと、管理画面にアクセスできなくなります
> - プロバイダによっては動的IPアドレスのため、IPが変わる可能性があります
> - 設定を解除するには、値を空にするか行をコメントアウトしてください

---

## CSPを有効にしたい

**CSP（Content Security Policy）**は、クロスサイトスクリプティング（XSS）攻撃などを防ぐためのセキュリティ機能です。

### CSPとは？

CSPは、Webページが読み込めるリソース（スクリプト、画像、スタイルシートなど）の**許可リスト**を定義する仕組みです。

| メリット | 説明 |
|---------|------|
| XSS対策 | 悪意のあるスクリプトの実行を防止 |
| データ漏洩防止 | 不正な外部サーバーへのデータ送信を防止 |

### 設定手順

1. Firebase Studioを開く

2. 左側のエクスプローラーで「**.env**」ファイルをクリック

3. 以下の行を編集します

```
# CSP設定
# 検知のみモード `CSP_REPORT_ONLY=true`
# ブロックモード `CSP_REPORT_ONLY=false`
CSP_REPORT_ONLY=true
```

| 設定値 | 動作 |
|--------|------|
| `CSP_REPORT_ONLY=true` | 検知のみモード（違反を検知するが、ブロックしない） |
| `CSP_REPORT_ONLY=false` | ブロックモード（違反するリソースの読み込みをブロック） |

### 確認方法

ブラウザの開発者ツール → Network タブでレスポンスヘッダーを確認：

- **ブロックモード**: `Content-Security-Policy: default-src 'self'; ...`
- **検知のみモード**: `Content-Security-Policy-Report-Only: default-src 'self'; ...`

> **📌 推奨手順**
> 
> 1. まず`CSP_REPORT_ONLY=true`でテスト
> 2. ブラウザの開発者ツール（Console）にエラーが出ないことを確認
> 3. 問題がなければ`CSP_REPORT_ONLY=false`に切り替え
> 
> いきなりブロックモードにすると、意図しないリソースがブロックされてサイトが正しく動作しなくなる可能性があります。

---

## ログインの有効期間を調整したい

セッション（ログイン状態）の有効期間を変更できます。

### デフォルト設定

| 項目 | 値 |
|-----|-----|
| デフォルト有効期間 | 120時間（5日間） |
| 最大有効期間 | 336時間（2週間） |

### 設定手順

1. Firebase Studioを開く

2. 左側のエクスプローラーで「**.env**」ファイルをクリック

3. 以下の行を編集します

```
# セッション有効期間（時間単位、デフォルト: 120時間 = 5日間）
# 最大336時間（2週間）まで指定可能
SESSION_DURATION_HOURS=120
```

### トレードオフ

| 設定 | メリット | デメリット |
|-----|---------|-----------|
| **短くする**（例：24時間） | セキュリティ向上。不正アクセスのリスク軽減 | ユーザーが頻繁にログインし直す必要がある |
| **長くする**（例：336時間） | ユーザーの利便性向上。ログインの手間が減る | セキュリティリスクが上がる |

> **📌 推奨設定**
> 
> - 一般的なメディアサイト：デフォルト（120時間）で十分
> - セキュリティを重視：24〜72時間程度に短縮
> - 利便性を重視：最大336時間まで延長可能

---

## ローカルPCでhomepageを動かしたい

開発やカスタマイズのために、自分のPC上でhomepageを動作させることができます。

### 前提条件

- Node.js がインストール済み
- Git がインストール済み

### サービスアカウントキーの取得

1. Firebaseコンソールにログイン

👉 https://console.firebase.google.com/

2. 対象のプロジェクトを開く

3. 左上の**歯車マーク** → 「**プロジェクトの設定**」をクリック

4. 「**サービスアカウント**」タブをクリック

5. 「**新しい秘密鍵の生成**」ボタンをクリック

![サービスアカウントキーのダウンロード](screenshot/FIREBASE_SERVICE_ACCOUNT_KEY_DL.png)

6. JSONファイルがダウンロードされます

### .envファイルへの設定

1. ダウンロードしたJSONファイルの内容を1行に変換（改行を除去）

2. `.env`ファイルに以下のように設定

```
# Firebase Admin SDK サービスアカウントキー（サーバーサイドのみ）
FIREBASE_SERVICE_ACCOUNT_KEY='{"type": "service_account", "project_id": "...", "private_key": "...", ...}'
```

> **⚠️ 重要**
> 
> - 秘密鍵は絶対に公開しないでください
> - Gitにコミットしないでください
> - `.env`ファイルは`.gitignore`に含まれていることを確認してください

### Googleログインを動作させるには

ローカル環境でGoogleログインを動作させるには、追加の設定が必要です：

1. GCPコンソールの「**APIとサービス**」→「**認証情報**」を開く

2. OAuth 2.0 クライアントIDを選択

3. 以下を追加：
   - **承認済みの JavaScript 生成元**：`http://localhost:3000`（またはあなたのローカルURL）
   - **承認済みのリダイレクト URI**：`http://localhost:3000/auth/callback`

### Stripe決済を動作させるには

ローカル環境でStripe決済のWebhookを処理するには、**Stripe CLI**のセットアップが必要です。

1. Stripe CLIをインストール

👉 https://stripe.com/docs/stripe-cli

2. `stripe listen`コマンドでWebhookをローカルに転送

3. 生成される署名シークレットを`.env`に設定

> **📌 詳細な手順**
> 
> Stripe CLIの詳しい使い方については、Stripeの公式ドキュメントを参照してください。
> ローカル開発は上級者向けのため、ここでは概要のみの説明とします。

---

**このガイドは随時更新されます。**  
運用中に困ったことがあれば、このページを参照してください。

👉 セットアップ手順に戻る場合は [setup1.md](setup1.md) から確認できます。
