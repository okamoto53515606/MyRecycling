#!/bin/bash
# =============================================================================
# setup1.sh - Firebase Studio 初期セットアップスクリプト
# =============================================================================
# 
# このスクリプトで実行する処理:
#   1. 既存ファイルの削除（.git, .idx フォルダは保持）
#   2. GitHubからソースコードをダウンロード
#   3. 変更内容をGitにコミット
#   4. npm パッケージのインストール
#   5. .env ファイルの作成（env_template.txt からコピー）
#
# 使い方:
#   bash cli/setup1.sh
#
# =============================================================================

set -e  # エラー発生時にスクリプトを停止

# -----------------------------------------------------------------------------
# 1. 既存ファイルの削除（.git と .idx は保持）
# -----------------------------------------------------------------------------
echo "📁 既存ファイルを削除しています（.git, .idx は保持）..."
find . -maxdepth 1 \
  ! -name '.git' \
  ! -name '.idx' \
  ! -name '.' \
  -exec rm -rf {} +
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# 2. GitHubからソースコードをダウンロード
# -----------------------------------------------------------------------------
echo ""
echo "📥 GitHubからソースコードをダウンロードしています..."
curl -L https://github.com/okamoto53515606/MyRecycling/archive/refs/heads/main.tar.gz | \
  tar -xz --strip-components=1
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# 3. Gitに変更を反映
# -----------------------------------------------------------------------------
echo ""
echo "📝 Gitに変更をコミットしています..."
git add -A
git commit -m "Synchronized with okamoto53515606/MyRecycling"
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# 4. npm パッケージのインストール
# -----------------------------------------------------------------------------
echo ""
echo "📦 npm パッケージをインストールしています..."
echo "   （古いキャッシュを削除中...）"
rm -rf .next node_modules package-lock.json
echo "   （npm install 実行中...これには数分かかる場合があります）"
npm install
echo "   ✅ 完了"

# -----------------------------------------------------------------------------
# 5. 環境変数ファイルの作成
# -----------------------------------------------------------------------------
echo ""
echo "⚙️  環境変数ファイルを作成しています..."
cp env_template.txt .env
echo "   ✅ .env ファイルを作成しました"

# -----------------------------------------------------------------------------
# 完了メッセージ
# -----------------------------------------------------------------------------
echo ""
echo "=============================================="
echo "🎉 セットアップが完了しました！"
echo "=============================================="
